<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HCP Reach Calculator - Invivox</title>
  <style>
    /* —— Invivox Theme – Ocean Line —— */
    :root{
      --ocean-50:#e7f9fb; /* background */
      --ocean-100:#b5ecf2;
      --ocean-200:#92e2eb;
      --ocean-300:#41cddd;
      --ocean-400:#11c1d4;
      --ocean-500:#0fb0c1; /* accent / CTA */
      --ocean-600:#1f92ac;
      --ocean-700:#0c8997;
      --ocean-800:#096a75;
      --ocean-900:#075159; /* strong text */
    }

    * { box-sizing: border-box; }
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--ocean-50);
      color: var(--ocean-900);
    }
    header{
      background: linear-gradient(90deg, var(--ocean-500), var(--ocean-300));
      color:#fff; text-align:center; padding:32px 16px;
    }
    header h1{ margin:0 0 6px; font-size:28px; font-weight:700; }
    header p{ margin:0; opacity:.95; }

    main{ display:flex; justify-content:center; padding:48px 16px; }

    .card{
      width:100%; max-width:820px; background:#fff; border-radius:16px; padding:24px; 
      box-shadow: 0 10px 25px rgba(7,81,89,.07);
    }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .grid-full{ grid-column:1 / -1; }

    label{ font-weight:600; font-size:14px; margin-bottom:6px; display:block; }
    select, input[type="text"], input[type="email"]{
      width:100%; padding:12px 12px; border:1px solid #d8e6ea; border-radius:10px; font-size:16px; background:#fff;
    }

    .helper{ font-size:12px; color:#4b7e86; margin-top:4px; }

    .actions{ display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap: wrap; }
    .btn{
      appearance:none; border:none; cursor:pointer; border-radius:10px; padding:12px 18px; font-weight:600; font-size:16px;
      background: var(--ocean-500); color:#fff; box-shadow: 0 6px 14px rgba(15,176,193,.25);
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; box-shadow:none; }
    .btn.secondary{ background:#fff; color:var(--ocean-500); border:1px solid var(--ocean-500); }

    .consent{ display:flex; align-items:flex-start; gap:10px; font-size:14px; }
    .consent input{ margin-top:3px; }

    .toast{ margin-top:8px; font-size:14px; color: var(--ocean-800); display:none; }

    footer{ text-align:center; padding:20px; color: var(--ocean-900); background: var(--ocean-100); }

    @media (max-width:640px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>HCP Reach Calculator</h1>
    <p>Estimate how many healthcare professionals you can reach with Invivox</p>
  </header>

  <main>
    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title" style="margin:0 0 18px; font-size:22px;">Your simulation</h2>

      <form id="reachForm" novalidate>
        <div class="grid">
          <div>
            <label for="region">Region</label>
            <select id="region" name="region" required>
              <option value="">— Select —</option>
              <option>France</option>
              <option>Europe</option>
              <option>US</option>
            </select>
          </div>

          <div>
            <label for="specialite">Specialty</label>
            <!-- Keep values matching the data keys; labels shown in English -->
            <select id="specialite" name="specialite" required>
              <option value="">— Select —</option>
              <option value="MG">General Practitioner</option>
              <option value="Infirmier">Nurse</option>
              <option value="Dermatologues">Dermatologist</option>
              <option value="Pharmaciens">Pharmacist</option>
            </select>
          </div>

          <div>
            <label for="societe">Company</label>
            <input id="societe" name="societe" type="text" required placeholder="e.g., Invivox" />
          </div>
          <div>
            <label for="poste">Job title</label>
            <input id="poste" name="poste" type="text" required placeholder="e.g., Marketing Manager" />
          </div>
          <div class="grid-full">
            <label for="email">Work email</label>
            <input id="email" name="email" type="email" required placeholder="firstname.lastname@company.com" />
            <div class="helper" id="emailHelp"></div>
          </div>

          <div class="grid-full consent">
            <input id="consent" name="consent" type="checkbox" required />
            <label for="consent">I agree that my information will be used to send me the simulation result. (GDPR)</label>
          </div>
        </div>

        <div class="actions">
          <button id="downloadBtn" class="btn" type="submit" disabled>Download result</button>
          <a class="btn secondary" href="https://calendly.com/adevige-invivox/30min" target="_blank" rel="noopener noreferrer">Request a demo</a>
        </div>

        <div class="toast" id="toast" role="status" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <footer>© 2025 Invivox. All rights reserved.</footer>

  <script>
    // —— CONFIG ——
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzS6-DukqRR4lAJhiIg2fR5FpNJ2tWEDEjmScu5h6VI5SPAmaKy4npO-1l-bOFtiOwvPg/exec';

    // —— Data ——
    const data = {
      France: { MG: 37000, Infirmier: 300000, Dermatologues: 1600, Pharmaciens: 42000 },
      Europe: { MG: 120000, Infirmier: 700000, Dermatologues: 6600, Pharmaciens: 80000 },
      US: { MG: 24000, Infirmier: 400000, Dermatologues: 2600, Pharmaciens: 51000 }
    };

    // —— Selectors ——
    const form = document.getElementById('reachForm');
    const regionEl = document.getElementById('region');
    const specEl = document.getElementById('specialite');
    const emailEl = document.getElementById('email');
    const emailHelp = document.getElementById('emailHelp');
    const downloadBtn = document.getElementById('downloadBtn');
    const toast = document.getElementById('toast');
    const consentEl = document.getElementById('consent');

    // —— Email rules ——
    const blockedDomains = [
      'gmail.com','googlemail.com','aol.com','icloud.com','me.com','mac.com','msn.com',
      'hotmail.com','outlook.com','live.com','gmx.com','protonmail.com','proton.me','pm.me',
      'wanadoo.fr','wanadoo.com','orange.fr','sfr.fr','free.fr','laposte.net','bbox.fr','numericable.fr','neuf.fr','voila.fr','aliceadsl.fr','tiscali.fr','libertysurf.fr','caramail.com',
      'gmx.fr',
      'yahoo.com','yahoo.fr','yahoo.co.uk','yahoo.es','yahoo.it','yahoo.de',
      'hotmail.fr','hotmail.co.uk','outlook.fr','outlook.es','outlook.it','live.fr'
    ];

    function getDomain(email){
      const at = email.lastIndexOf('@');
      return at > -1 ? email.slice(at+1).toLowerCase() : '';
    }
    function isValidEmailFormat(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email);
    }
    function validateEmailField(){
      emailEl.setCustomValidity('');
      emailHelp.textContent = '';
      const email = emailEl.value.trim();
      if(!email) return;
      if(!isValidEmailFormat(email)){
        emailEl.setCustomValidity("Invalid email format");
        emailHelp.textContent = "Example: firstname.lastname@company.com";
        return;
      }
      const domain = getDomain(email);
      if(blockedDomains.includes(domain)){
        emailEl.setCustomValidity("Please use a professional email address (personal domains are blocked).");
        emailHelp.textContent = `The domain "${domain}" is blocked.`;
      }
    }

    // —— Helpers ——
    const pad = n => String(n).padStart(2,'0');
    function currentTimestamp(){
      const d = new Date();
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}`;
    }

    function compute(){
      const region = regionEl.value;
      const regionLabel = regionEl.options[regionEl.selectedIndex]?.textContent || region;
      const specialite = specEl.value; // key for data
      const specialiteLabel = specEl.options[specEl.selectedIndex]?.textContent || specialite;
      if(!region || !specialite) return null;
      const baseReach = data[region][specialite];
      return { region, regionLabel, specialite, specialiteLabel, baseReach };
    }

    // —— Style A (single) ——
    function buildTextReport(values){
      const { regionLabel, specialiteLabel, baseReach } = values;
      const title = 'INVIVOX · HCP Reach Calculator';
      const width = 64;
      const padLine = (s)=>{
        const left = Math.floor((width - 2 - s.length)/2);
        const right = width - 2 - s.length - left;
        return '│' + ' '.repeat(Math.max(0,left)) + s + ' '.repeat(Math.max(0,right)) + '│';
      };
      const line = '─'.repeat(width-2);
      return [
        '┌'+line+'┐',
        padLine(title),
        '└'+line+'┘',
        '',
        'RESULTS',
        `- Region        : ${regionLabel}`,
        `- Specialty     : ${specialiteLabel}`,
        `- Estimated reach : ${baseReach.toLocaleString('en-US')} HCPs`,
        '',
        'Thank you for your reach request.',
        'If you want to know how to reach this audience, contact us at:',
        'mailto:adevige@invivox.com'
      ].join('\n');
    }

    function triggerDownload(filename, content, mime){
      const blob = new Blob([content], { type: mime || 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    function setToast(msg){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=> toast.style.display='none', 4000); }
    function checkValidity(){ validateEmailField(); downloadBtn.disabled = !form.checkValidity() || !compute(); }

    async function saveLead(values){
      const params = new URLSearchParams();
      params.append('timestamp', new Date().toISOString());
      params.append('societe', form.societe.value.trim());
      params.append('poste', form.poste.value.trim());
      params.append('email', emailEl.value.trim());
      params.append('region', values.region);
      params.append('specialite', values.specialite);
      params.append('reach_total', String(values.baseReach));
      params.append('userAgent', navigator.userAgent);
      params.append('referrer', document.referrer);

      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: params.toString()
      });

      let data;
      try { data = await res.json(); } catch(e){ data = { result:'ok' }; }
      return data;
    }

    // —— Events ——
    form.addEventListener('input', checkValidity);
    emailEl.addEventListener('input', checkValidity);
    regionEl.addEventListener('change', checkValidity);
    specEl.addEventListener('change', checkValidity);
    consentEl.addEventListener('change', checkValidity);

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      validateEmailField();
      if(!form.checkValidity()) { form.reportValidity(); return; }
      const values = compute();
      if(!values){ setToast('Please select a region and a specialty.'); return; }

      downloadBtn.disabled = true;

      try{
        const result = await saveLead(values);
        if(result && result.result === 'error'){
          setToast(result.message || 'Email address rejected.');
          downloadBtn.disabled = false;
          return;
        }
      }catch(err){
        console.warn('Lead save error:', err);
        setToast('Note: lead not confirmed saved to Google Sheets.');
      }

      const ts = currentTimestamp();
      const baseName = `reach_${values.region}_${values.specialite}_${ts}`.replace(/\s+/g,'');
      const txt = buildTextReport(values);
      triggerDownload(baseName + '.txt', txt, 'text/plain;charset=utf-8');

      setToast('Download started.');
      form.reset();
      checkValidity();
    });

    // init
    checkValidity();
  </script>
</body>
</html>
